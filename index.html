<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Gold Rush!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the game */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background for space theme */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0; /* Remove body padding to allow full screen canvas */
            box-sizing: border-box;
            color: #e2e8f0; /* Light text color */
            overflow: hidden; /* Prevent scrollbars due to preloader/full screen */
        }

        /* Preloader styles */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.ibb.co/CpNDPHHG/Gemini-Generated-Image-rqajpfrqajpfrqaj.png'); /* Preloader background */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3rem;
            font-weight: 800;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        #preloader.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interactions once hidden */
        }

        .preloader-text {
            animation: pulse 1.5s infinite alternate;
            text-shadow: 0 0 10px rgba(74, 144, 226, 0.7);
        }

        .preloader-watermark {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }

        /* Main game wrapper */
        .game-wrapper {
            background-color: #2d3748; /* Darker gray for container */
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            text-align: center;
            max-width: 900px; /* Wider for game + upgrades */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative; /* For watermark positioning */
            background-image: url('https://i.ibb.co/CpNDPHHG/Gemini-Generated-Image-rqajpfrqajpfrqaj.png'); /* Main game background */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0; /* Hidden initially, shown after preloader */
            transition: opacity 1s ease-in;
            box-sizing: border-box; /* Include padding in width/height */
            overflow-y: auto; /* Allow scrolling for content that overflows vertically */
            max-height: 100vh; /* Limit height to viewport height */
        }

        .game-wrapper.show {
            opacity: 1;
        }

        .game-wrapper.hide {
            opacity: 0;
            pointer-events: none; /* Disable interactions while fading out */
        }

        .main-watermark {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.3);
            z-index: 10; /* Ensure it's above other elements */
        }

        canvas {
            background-color: #000000; /* Black for space */
            border: 2px solid #4a5568; /* Subtle border */
            border-radius: 0.75rem;
            display: block;
            margin: 0 auto;
            touch-action: none; /* Disable default touch actions like scrolling/zooming */
            opacity: 0; /* Start hidden for smooth fade-in */
            transition: opacity 0.5s ease-in, width 0.5s ease-in-out, height 0.5s ease-in-out, border-radius 0.5s ease-in-out;
        }

        /* Full-screen canvas for gameplay */
        canvas.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important; /* Override width */
            height: 100vh !important; /* Override height */
            border-radius: 0;
            z-index: 999; /* Below preloader, above everything else */
            opacity: 1; /* Fully visible when fullscreen */
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #cbd5e0;
        }

        .upgrade-section {
            background-color: rgba(44, 62, 80, 0.8); /* Slightly different dark shade with transparency */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .upgrade-buttons, .ship-selection-nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .upgrade-button, .buy-ship-button, .buy-coins-button, .redeem-button, .nav-button {
            background-color: #4a90e2; /* Blue for upgrades */
            color: white;
            font-weight: 700;
            padding: 0.8rem 1.2rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
        }

        .upgrade-button:hover:not(:disabled), .buy-ship-button:hover:not(:disabled), .buy-coins-button:hover:not(:disabled), .redeem-button:hover:not(:disabled), .nav-button:hover:not(:disabled) {
            background-color: #357ABD;
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        .upgrade-button:disabled, .buy-ship-button:disabled, .redeem-button:disabled, .nav-button:disabled {
            background-color: #4a5568; /* Gray out when disabled */
            cursor: not-allowed;
            opacity: 0.7;
        }

        .start-button {
            background-color: #48bb78; /* Green for start */
            color: white;
            font-weight: 800;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .start-button:hover {
            background-color: #38a169;
            transform: translateY(-3px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .message-box {
            background-color: #fefcbf;
            border: 1px solid #fbd38d;
            color: #975a16;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-weight: 600;
            display: none;
        }

        .message-box.show {
            display: block;
        }

        .redeem-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1rem;
            background-color: rgba(59, 78, 97, 0.8);
            border-radius: 0.75rem;
        }

        .redeem-input {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            color: #e2e8f0;
            width: 100%;
            box-sizing: border-box;
        }

        .footer {
            margin-top: 2rem;
            text-align: center;
            opacity: 0; /* Hidden initially, shown after preloader */
            transition: opacity 1s ease-in;
            padding-bottom: 20px; /* Add some padding for the footer */
        }

        .footer.show {
            opacity: 1;
        }

        .footer.hide {
            opacity: 0;
            pointer-events: none;
        }

        .footer img {
            max-width: 100px;
            height: auto;
            border-radius: 0.5rem;
        }

        .ship-display-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ship-display-area img {
            max-width: 150px;
            height: auto;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .ship-stats-table {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            text-align: left;
            border-collapse: collapse;
            color: #cbd5e0;
        }

        .ship-stats-table th, .ship-stats-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #4a5568;
        }

        .ship-stats-table th {
            font-weight: 600;
            color: #a0aec0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-wrapper {
                padding: 1.5rem;
                gap: 1rem;
            }
            .game-stats {
                font-size: 1.1rem;
                gap: 0.75rem;
            }
            .upgrade-section {
                padding: 1rem;
            }
            .upgrade-button, .buy-ship-button, .buy-coins-button, .redeem-button, .nav-button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .game-wrapper {
                padding: 1rem;
            }
            h1 {
                font-size: 1.75rem;
            }
            .game-stats {
                font-size: 1rem;
                flex-direction: column;
            }
            .upgrade-buttons, .ship-selection-nav {
                flex-direction: column;
                align-items: stretch;
            }
            .upgrade-button, .buy-ship-button, .buy-coins-button, .redeem-button, .nav-button {
                width: 100%;
            }
            .preloader-text {
                font-size: 2rem;
            }
            .preloader-watermark {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <!-- Preloader -->
    <div id="preloader">
        <div class="preloader-text">Cosmo Attack</div>
        <div class="preloader-watermark">Powered by <a href="https://zenora-ai.vercel.app/" target="_blank" class="text-blue-300 hover:underline">zenora-ai.vercel.app</a></div>
    </div>

    <div class="game-wrapper" id="gameWrapper">
        <h1 class="text-4xl font-extrabold text-white mb-4">Galactic Gold Rush!</h1>

        <div class="game-stats">
            <span>Score: <span id="scoreDisplay">0</span></span>
            <span>Gold: <span id="goldDisplay">0</span> üí∞</span>
            <span>Health: <span id="healthDisplay">100</span> ‚ù§Ô∏è</span>
            <span>Ship: <span id="shipLevelDisplay">Level 1</span></span>
        </div>

        <canvas id="gameCanvas" width="600" height="400"></canvas>

        <button id="startButton" class="start-button">Start Game</button>

        <div id="messageBox" class="message-box">
            Welcome, pilot! Destroy aliens, collect gold, and upgrade your ship! Use A/D or Left/Right arrows to move, Spacebar to shoot.
        </div>

        <div class="upgrade-section">
            <h2 class="text-2xl font-bold text-white mb-3">Ship Selection & Upgrades</h2>

            <div class="ship-display-area">
                <img id="selectedShipImage" src="" alt="Selected Spaceship">
                <h3 class="text-xl font-semibold text-white" id="selectedShipName"></h3>
                <table class="ship-stats-table">
                    <tr><th>Health</th><td id="displayHealth"></td></tr>
                    <tr><th>Firepower</th><td id="displayFirepower"></td></tr>
                    <tr><th>Speed</th><td id="displaySpeed"></td></tr>
                    <tr><th>Fire Rate</th><td id="displayFireRate"></td></tr>
                </table>
            </div>

            <div class="ship-selection-nav">
                <button id="prevShipBtn" class="nav-button">‚óÄÔ∏è Previous Ship</button>
                <button id="nextShipBtn" class="nav-button">Next Ship ‚ñ∂Ô∏è</button>
            </div>

            <div class="upgrade-buttons">
                <button id="upgradeHealthBtn" class="upgrade-button">
                    Upgrade Health (<span id="healthCost">50</span> üí∞)
                </button>
                <button id="upgradeFirepowerBtn" class="upgrade-button">
                    Upgrade Firepower (<span id="firepowerCost">75</span> üí∞)
                </button>
                <button id="upgradeSpeedBtn" class="upgrade-button">
                    Upgrade Speed (<span id="speedCost">60</span> üí∞)
                </button>
                <button id="buyNewShipBtn" class="buy-ship-button">
                    Buy This Ship (<span id="newShipCost">1000</span> üí∞)
                </button>
            </div>
            <div class="text-sm text-gray-400 mt-2" id="upgradeInfo">
                Current Ship: <span id="currentShipName">Basic Fighter</span> | Health: <span id="currentHealthStat">100</span> | Firepower: <span id="currentFirepowerStat">10</span> | Speed: <span id="currentSpeedStat">5</span>
            </div>
        </div>

        <div class="upgrade-section">
            <h2 class="text-2xl font-bold text-white mb-3">Gold Options</h2>
            <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                <a href="https://tally.so/r/3x7Bl5" target="_blank" class="buy-coins-button w-full md:w-auto">
                    Buy Coins Online üõí
                </a>
                <div class="redeem-section w-full md:w-auto">
                    <input type="text" id="redeemCodeInput" placeholder="Enter Redeem Code" class="redeem-input">
                    <button id="redeemCodeBtn" class="redeem-button">Redeem Code</button>
                </div>
            </div>
        </div>

        <div class="main-watermark">Powered by <a href="https://zenora-ai.vercel.app/" target="_blank" class="text-blue-300 hover:underline">zenora-ai.vercel.app</a></div>
    </div>

    <footer class="footer" id="gameFooter">
        <img src="https://i.ibb.co/JRsMXc4G/Gemini-Generated-Image-gyfxkzgyfxkzgyfx.png" alt="Website Logo">
    </footer>

    <script>
        // --- DOM Elements ---
        const preloader = document.getElementById('preloader');
        const gameWrapper = document.getElementById('gameWrapper');
        const gameFooter = document.getElementById('gameFooter');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const goldDisplay = document.getElementById('goldDisplay');
        const healthDisplay = document.getElementById('healthDisplay');
        const shipLevelDisplay = document.getElementById('shipLevelDisplay');
        const startButton = document.getElementById('startButton');
        const messageBox = document.getElementById('messageBox');

        const upgradeHealthBtn = document.getElementById('upgradeHealthBtn');
        const upgradeFirepowerBtn = document.getElementById('upgradeFirepowerBtn');
        const upgradeSpeedBtn = document.getElementById('upgradeSpeedBtn');
        const buyNewShipBtn = document.getElementById('buyNewShipBtn');

        const healthCostDisplay = document.getElementById('healthCost');
        const firepowerCostDisplay = document.getElementById('firepowerCost');
        const speedCostDisplay = document.getElementById('speedCost');
        const newShipCostDisplay = document.getElementById('newShipCost');

        const currentShipName = document.getElementById('currentShipName');
        const currentHealthStat = document.getElementById('currentHealthStat');
        const currentFirepowerStat = document.getElementById('currentFirepowerStat');
        const currentSpeedStat = document.getElementById('currentSpeedStat');

        const selectedShipImage = document.getElementById('selectedShipImage');
        const selectedShipName = document.getElementById('selectedShipName');
        const displayHealth = document.getElementById('displayHealth');
        const displayFirepower = document.getElementById('displayFirepower');
        const displaySpeed = document.getElementById('displaySpeed');
        const displayFireRate = document.getElementById('displayFireRate');
        const prevShipBtn = document.getElementById('prevShipBtn');
        const nextShipBtn = document.getElementById('nextShipBtn');

        const redeemCodeInput = document.getElementById('redeemCodeInput');
        const redeemCodeBtn = document.getElementById('redeemCodeBtn');

        // --- Game State Variables ---
        let gameActive = false;
        let score = 0;
        let gold = 0;
        let player = {}; // Player object
        let bullets = []; // Array to hold active bullets
        let aliens = [];  // Array to hold active aliens
        let coins = [];   // Array to hold active coins
        let powerups = []; // Array to hold active power-ups
        let boss = null; // Boss object
        let bossActive = false; // Flag for boss presence

        let keys = {}; // Object to track pressed keys for smooth movement

        // Game difficulty and spawning
        let alienSpawnInterval = 1500; // Milliseconds between alien spawns
        let lastAlienSpawnTime = 0;
        let gameSpeedMultiplier = 1; // Increases over time for difficulty
        let bossSpawnThreshold = 5000; // Score to trigger first boss spawn
        let lastBossSpawnScore = 0;

        // Upgrade costs and levels for individual stats (per ship)
        const UPGRADE_BASE_COST = {
            health: 50,
            firepower: 75,
            speed: 60,
        };
        const UPGRADE_COST_MULTIPLIER = 1.5; // Cost increases by this factor each level
        const MAX_INDIVIDUAL_UPGRADE_LEVEL = 3; // Max levels for health, firepower, speed

        // Player Ship Definitions - Adjusted Health for 2000+ Max Health
        const playerShips = [
            {
                name: "Basic Fighter",
                src: 'https://i.ibb.co/Zp91vZM1/Add-a-subheading-3-removebg-preview.png',
                baseWidth: 60,
                baseHeight: 60,
                baseHealth: 500, // Adjusted
                baseFirepower: 10,
                baseSpeed: 5,
                baseFireRate: 300,
                cost: 0
            },
            {
                name: "Advanced Interceptor",
                src: 'https://i.ibb.co/5gN4kQPm/Add-a-subheading-4-removebg-preview.png',
                baseWidth: 70,
                baseHeight: 70,
                baseHealth: 700, // Adjusted
                baseFirepower: 15,
                baseSpeed: 6,
                baseFireRate: 250,
                cost: 1000
            },
            {
                name: "Galactic Cruiser",
                src: 'https://i.ibb.co/XxxmMMYG/Add-a-subheading-5-removebg-preview.png',
                baseWidth: 80,
                baseHeight: 80,
                baseHealth: 900, // Adjusted
                baseFirepower: 20,
                baseSpeed: 7,
                baseFireRate: 200,
                cost: 5000
            },
            {
                name: "Cosmic Destroyer",
                src: 'https://i.ibb.co/ns63zjhR/Add-a-subheading-6-removebg-preview.png',
                baseWidth: 90,
                baseHeight: 90,
                baseHealth: 1200, // Adjusted
                baseFirepower: 25,
                baseSpeed: 8,
                baseFireRate: 180,
                cost: 15000
            },
            {
                name: "Star Conqueror",
                src: 'https://i.ibb.co/0yBxnkXc/Add-a-subheading-7-removebg-preview.png',
                baseWidth: 100,
                baseHeight: 100,
                baseHealth: 1500, // Adjusted
                baseFirepower: 30,
                baseSpeed: 9,
                baseFireRate: 150,
                cost: 30000
            },
            {
                name: "Omega Dreadnought",
                src: 'https://i.ibb.co/LmryyQX/Add-a-subheading-8-removebg-preview.png',
                baseWidth: 110,
                baseHeight: 110,
                baseHealth: 1850, // Adjusted for ~2000 max health
                baseFirepower: 40,
                baseSpeed: 10,
                baseFireRate: 120,
                cost: 50000
            }
        ];

        // Alien Ship Definitions
        const alienShips = [
            'https://i.ibb.co/H1wtjD3/21-removebg-preview.png',
            'https://i.ibb.co/qYZDjdYK/22-removebg-preview.png',
            'https://i.ibb.co/Sk0S6Ln/23-removebg-preview.png',
            'https://i.ibb.co/nZMTxSJ/24-removebg-preview.png',
            'https://i.ibb.co/5WmmmJBg/25-removebg-preview.png',
            'https://i.ibb.co/bMfTXBPs/26-removebg-preview.png'
        ];

        // Boss Ship Definitions
        const bossShips = [
            'https://i.ibb.co/60tHqjVH/29-removebg-preview.png',
            'https://i.ibb.co/yc594vt1/28-removebg-preview.png',
            'https://i.ibb.co/cSGZdHtc/30-removebg-preview.png',
            'https://i.ibb.co/5WyDghFc/27-removebg-preview.png',
            'https://i.ibb.co/tTV2TGgB/32-removebg-preview.png',
            'https://i.ibb.co/FT0nGkd/31-removebg-preview.png'
        ];

        // Power-up Definitions
        const powerUpTypes = [
            { name: "Rapid Fire", emoji: "üî•", duration: 5000, effect: "fireRate" },
            { name: "Shield", emoji: "üõ°Ô∏è", duration: 7000, effect: "shield" },
            { name: "Gold Magnet", emoji: "üß≤", duration: 10000, effect: "goldMagnet" }
        ];
        let activePowerUp = null;
        let powerUpEndTime = 0;
        let powerUpSpawnCounter = 0; // Counter for power-up spawning
        const POWERUP_SPAWN_ALIEN_COUNT = 10; // Spawn a power-up every 10 aliens defeated

        // Preloaded Image Objects
        const images = {};
        const imageSources = [
            // Player Ships
            ...playerShips.map(ship => ship.src),
            // Alien Ships
            ...alienShips,
            // Boss Ships
            ...bossShips,
            // Backgrounds and Logo
            'https://i.ibb.co/CpNDPHHG/Gemini-Generated-Image-rqajpfrqajpfrqaj.png', // Main background
            'https://i.ibb.co/JRsMXc4G/Gemini-Generated-Image-gyfxkzgyfxkzgyfx.png' // Footer logo
        ];

        // Current ship being viewed in the upgrade section
        let viewedShipIndex = 0;

        // --- Game Entities (Classes) ---

        /**
         * Represents the player's spaceship.
         */
        class Player {
            constructor() {
                this.currentShipIndex = 0; // This will be set by initializeGame or buyNewShip
                this.upgradeLevels = { // Individual upgrades for the current ship
                    health: 0,
                    firepower: 0,
                    speed: 0,
                };
                this.loadShipStats(); // Load stats based on currentShipIndex
                this.x = canvas.width / 2 - this.width / 2;
                this.y = canvas.height - this.height - 20;
                this.health = this.maxHealth; // Start with full health
                this.lastShotTime = 0;
                this.isShielded = false;
            }

            /**
             * Loads the current ship's base stats and applies individual upgrades.
             */
            loadShipStats() {
                const ship = playerShips[this.currentShipIndex];
                this.image = images[ship.src];
                this.width = ship.baseWidth;
                this.height = ship.baseHeight;
                this.baseSpeed = ship.baseSpeed;
                this.baseHealth = ship.baseHealth;
                this.baseFirepower = ship.baseFirepower;
                this.baseFireRate = ship.baseFireRate;

                // Apply individual upgrades on top of base stats
                this.maxHealth = this.baseHealth + (this.upgradeLevels.health * 50); // +50 max health per level
                this.firepower = this.baseFirepower + (this.upgradeLevels.firepower * 5); // +5 damage per level
                this.speed = this.baseSpeed + (this.upgradeLevels.speed * 1.5); // +1.5 speed per level
                this.fireRate = this.baseFireRate - (this.upgradeLevels.firepower * 20); // Faster fire rate with firepower upgrades

                // Ensure fireRate doesn't go below a minimum
                this.fireRate = Math.max(50, this.fireRate);
            }

            /**
             * Draws the player on the canvas.
             */
            draw() {
                if (this.image && this.image.complete) {
                    ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                } else {
                    // Fallback if image not loaded
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }

                if (this.isShielded) {
                    ctx.beginPath();
                    ctx.arc(this.x + this.width / 2, this.y + this.height / 2, this.width / 2 + 10, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(0, 255, 255, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            }

            /**
             * Updates player position based on key presses.
             */
            update() {
                if (keys['ArrowLeft'] || keys['a']) {
                    this.x -= this.speed;
                }
                if (keys['ArrowRight'] || keys['d']) {
                    this.x += this.speed;
                }

                // Keep player within canvas bounds
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;

                // Handle shooting
                // Apply rapid fire effect if active
                let currentFireRate = this.fireRate;
                if (activePowerUp && activePowerUp.effect === "fireRate") {
                    currentFireRate /= 2; // Double fire rate
                }

                if (keys['Space'] && (Date.now() - this.lastShotTime > currentFireRate)) {
                    this.shoot();
                    this.lastShotTime = Date.now();
                }
            }

            /**
             * Creates a new bullet and adds it to the bullets array.
             */
            shoot() {
                bullets.push(new Bullet(this.x + this.width / 2 - 5, this.y, this.firepower));
            }

            /**
             * Reduces player health.
             * @param {number} damage The amount of damage to take.
             */
            takeDamage(damage) {
                if (this.isShielded) {
                    showMessage("Shield absorbed damage!");
                    return; // No damage taken if shielded
                }
                this.health -= damage;
                if (this.health <= 0) {
                    this.health = 0;
                    gameOver();
                }
                updateUI();
            }

            /**
             * Heals the player up to max health.
             * @param {number} amount The amount to heal.
             */
            heal(amount) {
                this.health = Math.min(this.maxHealth, this.health + amount);
                updateUI();
            }
        }

        /**
         * Represents a bullet fired by the player.
         */
        class Bullet {
            constructor(x, y, damage) {
                this.x = x;
                this.y = y;
                this.width = 10;
                this.height = 20;
                this.speed = 10;
                this.damage = damage;
                this.emoji = '‚ö°'; // Fallback emoji
            }

            /**
             * Draws the bullet on the canvas.
             */
            draw() {
                ctx.fillStyle = 'yellow';
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            /**
             * Updates the bullet's position.
             */
            update() {
                this.y -= this.speed;
            }
        }

        /**
         * Represents an alien enemy.
         */
        class Alien {
            constructor(x, y, level) {
                this.x = x;
                this.y = y;
                this.width = 35;
                this.height = 35;
                this.baseSpeed = 1 + (level * 0.2); // Speed increases with level
                this.speed = this.baseSpeed * gameSpeedMultiplier;
                this.baseHealth = 20 + (level * 5); // Health increases with level
                this.health = this.baseHealth;
                this.image = images[alienShips[level % alienShips.length]]; // Cycle through alien images
                this.goldValue = 10 + (level * 2); // Gold value increases with level
                this.scoreValue = 100 + (level * 20); // Score value increases with level
            }

            /**
             * Draws the alien on the canvas.
             */
            draw() {
                if (this.image && this.image.complete) {
                    ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                } else {
                    ctx.font = `${this.height}px Arial`;
                    ctx.fillText('üëΩ', this.x, this.y + this.height); // Fallback emoji
                }
            }

            /**
             * Updates the alien's position.
             */
            update() {
                this.y += this.speed;
            }

            /**
             * Reduces alien health.
             * @param {number} damage The amount of damage to take.
             * @returns {boolean} True if the alien is destroyed, false otherwise.
             */
            takeDamage(damage) {
                this.health -= damage;
                if (this.health <= 0) {
                    return true; // Alien destroyed
                }
                return false;
            }
        }

        /**
         * Represents a boss enemy.
         */
        class Boss {
            constructor(level) {
                this.width = 120;
                this.height = 120;
                this.x = canvas.width / 2 - this.width / 2;
                this.y = -this.height; // Start off-screen
                this.speed = 0.5 + (level * 0.1);
                this.health = 500 + (level * 100);
                this.maxHealth = this.health;
                this.damage = 1; // Damage per tick to player
                this.attackInterval = 500; // Milliseconds between attacks
                this.lastAttackTime = 0;
                this.image = images[bossShips[level % bossShips.length]]; // Cycle through boss images
                this.goldValue = 500 + (level * 100);
                this.scoreValue = 5000 + (level * 1000);
                this.targetY = 50; // Y position where boss stops
                this.movingDown = true;
            }

            /**
             * Draws the boss on the canvas.
             */
            draw() {
                if (this.image && this.image.complete) {
                    ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                } else {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(this.x, this.y, this.width, this.height); // Fallback
                }
                // Draw health bar
                const healthBarWidth = this.width;
                const healthBarHeight = 10;
                const healthBarX = this.x;
                const healthBarY = this.y - 15;
                ctx.fillStyle = 'gray';
                ctx.fillRect(healthBarX, healthBarY, healthBarWidth, healthBarHeight);
                ctx.fillStyle = 'lime';
                ctx.fillRect(healthBarX, healthBarY, (this.health / this.maxHealth) * healthBarWidth, healthBarHeight);
            }

            /**
             * Updates the boss's position and attacks.
             */
            update() {
                if (this.movingDown) {
                    this.y += this.speed;
                    if (this.y >= this.targetY) {
                        this.y = this.targetY;
                        this.movingDown = false;
                    }
                }

                // Boss attacks player periodically
                if (Date.now() - this.lastAttackTime > this.attackInterval) {
                    player.takeDamage(this.damage);
                    this.lastAttackTime = Date.now();
                }
            }

            /**
             * Reduces boss health.
             * @param {number} damage The amount of damage to take.
             * @returns {boolean} True if the boss is destroyed, false otherwise.
             */
            takeDamage(damage) {
                this.health -= damage;
                if (this.health <= 0) {
                    return true; // Boss destroyed
                }
                return false;
            }
        }

        /**
         * Represents a gold coin.
         */
        class Coin {
            constructor(x, y, value) {
                this.x = x;
                this.y = y;
                this.width = 25;
                this.height = 25;
                this.speed = 3;
                this.value = value;
                this.emoji = 'üí∞';
            }

            /**
             * Draws the coin on the canvas.
             */
            draw() {
                ctx.font = `${this.height}px Arial`;
                ctx.fillText(this.emoji, this.x, this.y + this.height);
            }

            /**
             * Updates the coin's position.
             */
            update() {
                this.y += this.speed;
            }
        }

        /**
         * Represents a power-up.
         */
        class PowerUp {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 30;
                this.speed = 2;
                this.type = type; // Object from powerUpTypes
            }

            /**
             * Draws the power-up on the canvas.
             */
            draw() {
                ctx.font = `${this.height}px Arial`;
                ctx.fillText(this.type.emoji, this.x, this.y + this.height);
            }

            /**
             * Updates the power-up's position.
             */
            update() {
                this.y += this.speed;
            }
        }

        // --- Game Functions ---

        /**
         * Preloads all necessary images before starting the game.
         */
        function preloadAssets() {
            let loadedCount = 0;
            const totalAssets = imageSources.length;

            if (totalAssets === 0) {
                hidePreloader();
                return;
            }

            imageSources.forEach(src => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    images[src] = img;
                    loadedCount++;
                    if (loadedCount === totalAssets) {
                        hidePreloader();
                    }
                };
                img.onerror = () => {
                    console.error(`Failed to load image: ${src}`);
                    loadedCount++; // Still increment to avoid endless loading if an image fails
                    if (loadedCount === totalAssets) {
                        hidePreloader();
                    }
                };
            });
        }

        /**
         * Hides the preloader and shows the main game content.
         */
        function hidePreloader() {
            preloader.classList.add('hidden');
            preloader.addEventListener('transitionend', () => {
                preloader.style.display = 'none';
                gameWrapper.classList.add('show');
                gameFooter.classList.add('show');
                initializeGame(); // Initialize game after assets are loaded
            }, { once: true });
        }


        /**
         * Initializes or resets the game state.
         */
        function initializeGame() {
            score = 0;
            gold = 0;
            bullets = [];
            aliens = [];
            coins = [];
            powerups = [];
            boss = null;
            bossActive = false;
            keys = {};
            alienSpawnInterval = 1500;
            lastAlienSpawnTime = 0;
            gameSpeedMultiplier = 1;
            bossSpawnThreshold = 5000;
            lastBossSpawnScore = 0;
            powerUpSpawnCounter = 0;
            activePowerUp = null;
            powerUpEndTime = 0;

            player = new Player(); // Create new player instance (defaults to first ship)
            viewedShipIndex = player.currentShipIndex; // Set viewed ship to current player ship

            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates();
            displayShipDetails(viewedShipIndex); // Display initial ship details
            showMessage("Welcome, pilot! Destroy aliens, collect gold, and upgrade your ship! Use A/D or Left/Right arrows to move, Spacebar to shoot.");
            startButton.style.display = 'block';
            // Ensure canvas is not full screen in menu and game wrapper is visible
            canvas.classList.remove('fullscreen');
            canvas.style.opacity = '0'; // Ensure canvas starts hidden in menu
            gameWrapper.classList.remove('hide'); // Ensure wrapper is not hidden
            gameWrapper.style.display = 'flex';
            gameFooter.classList.remove('hide');
            gameFooter.style.display = 'block';
        }

        /**
         * Starts the main game loop.
         */
        function startGame() {
            gameActive = true;
            score = 0;
            gold = 0;
            bullets = [];
            aliens = [];
            coins = [];
            powerups = [];
            boss = null;
            bossActive = false;
            keys = {};
            alienSpawnInterval = 1500;
            lastAlienSpawnTime = Date.now(); // Reset spawn timer
            gameSpeedMultiplier = 1;
            bossSpawnThreshold = 5000;
            lastBossSpawnScore = 0;
            powerUpSpawnCounter = 0;
            activePowerUp = null;
            powerUpEndTime = 0;

            // Hide game wrapper and footer with transition
            gameWrapper.classList.remove('show');
            gameWrapper.classList.add('hide');
            gameFooter.classList.remove('show');
            gameFooter.classList.add('hide');

            // Set canvas to full screen and fade in
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.classList.add('fullscreen');
            canvas.style.opacity = '1'; // Make canvas visible

            // Wait for gameWrapper to fade out before setting its display to none
            setTimeout(() => {
                gameWrapper.style.display = 'none';
                gameFooter.style.display = 'none';
            }, 1000); // Match CSS transition duration for opacity

            // Re-initialize player with current ship and upgrade levels
            player = new Player();
            player.x = canvas.width / 2 - player.width / 2; // Reposition player for new canvas size
            player.y = canvas.height - player.height - 20;
            player.health = player.maxHealth; // Ensure full health at start of new game
            player.isShielded = false; // Reset shield status

            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates(); // Ensure buttons are correct at start
            hideMessage();
            startButton.style.display = 'none';

            gameLoop(); // Start the game loop
        }

        /**
         * The main game loop, updates game state and redraws elements.
         */
        function gameLoop() {
            if (!gameActive) {
                // If game is not active, but canvas is fullscreen (meaning it was just game over),
                // reset canvas size and show game wrapper.
                if (canvas.classList.contains('fullscreen')) {
                    canvas.classList.remove('fullscreen');
                    canvas.style.opacity = '0'; // Fade out canvas
                    canvas.width = 600; // Reset to default menu size
                    canvas.height = 400;

                    // Show game wrapper and footer with transition
                    gameWrapper.style.display = 'flex';
                    gameFooter.style.display = 'block';
                    setTimeout(() => {
                        gameWrapper.classList.remove('hide');
                        gameWrapper.classList.add('show');
                        gameFooter.classList.remove('hide');
                        gameFooter.classList.add('show');
                    }, 10); // Small delay to re-apply 'show' class after display is set
                }
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

            const currentTime = Date.now();

            // --- Power-up duration check ---
            if (activePowerUp && currentTime > powerUpEndTime) {
                showMessage(`${activePowerUp.type.name} power-up expired!`);
                activePowerUp = null;
                player.isShielded = false; // Turn off shield if it was active
            }

            // --- Player Update ---
            player.update();
            player.draw();

            // --- Bullet Updates ---
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.update();
                bullet.draw();

                // Remove bullets that go off-screen
                if (bullet.y < 0) {
                    bullets.splice(i, 1);
                }
            }

            // --- Alien Spawning ---
            if (!bossActive && currentTime - lastAlienSpawnTime > alienSpawnInterval) {
                const alienX = Math.random() * (canvas.width - 40);
                const alienLevel = Math.floor(score / 500); // Alien level based on score
                aliens.push(new Alien(alienX, -40, alienLevel));
                lastAlienSpawnTime = currentTime;

                // Gradually increase game speed and decrease spawn interval
                gameSpeedMultiplier += 0.005;
                alienSpawnInterval = Math.max(500, alienSpawnInterval - 10); // Min interval 500ms
            }

            // --- Alien Updates ---
            for (let i = aliens.length - 1; i >= 0; i--) {
                const alien = aliens[i];
                alien.update();
                alien.draw();

                // Check collision with player
                if (checkCollision(player, alien)) {
                    player.takeDamage(10); // Player takes damage
                    aliens.splice(i, 1); // Remove alien
                    continue; // Skip to next alien
                }

                // Remove aliens that go off-screen
                if (alien.y > canvas.height) {
                    aliens.splice(i, 1);
                }
            }

            // --- Boss Spawning and Update ---
            if (!bossActive && score >= bossSpawnThreshold && score > lastBossSpawnScore) {
                const bossLevel = Math.floor(score / bossSpawnThreshold);
                boss = new Boss(bossLevel);
                bossActive = true;
                lastBossSpawnScore = score; // Update last boss spawn score
                showMessage("A powerful enemy approaches!");
            }

            if (bossActive && boss) {
                boss.update();
                boss.draw();
                // If boss goes off screen (shouldn't happen with current logic, but good for robustness)
                if (boss.y > canvas.height) {
                    bossActive = false;
                    boss = null;
                }
            }

            // --- Coin Updates ---
            for (let i = coins.length - 1; i >= 0; i--) {
                const coin = coins[i];
                coin.update();
                coin.draw();

                // Check collision with player to collect coin
                if (checkCollision(player, coin)) {
                    let collectedGold = coin.value;
                    if (activePowerUp && activePowerUp.effect === "goldMagnet") {
                        collectedGold *= 2; // Double gold if magnet is active
                        showMessage(`Gold magnet: +${collectedGold} gold!`);
                    }
                    gold += collectedGold;
                    coins.splice(i, 1); // Remove coin
                    updateUI();
                    checkUpgradeButtonStates(); // Recheck upgrade buttons after collecting gold
                    continue;
                }

                // Remove coins that go off-screen
                if (coin.y > canvas.height) {
                    coins.splice(i, 1);
                }
            }

            // --- PowerUp Updates ---
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                powerup.update();
                powerup.draw();

                // Check collision with player to collect power-up
                if (checkCollision(player, powerup)) {
                    activatePowerUp(powerup.type);
                    powerups.splice(i, 1); // Remove power-up
                    continue;
                }

                // Remove power-ups that go off-screen
                if (powerup.y > canvas.height) {
                    powerups.splice(i, 1);
                }
            }


            // --- Collision Detection (Bullets vs Aliens) ---
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                for (let j = aliens.length - 1; j >= 0; j--) {
                    const alien = aliens[j];

                    if (checkCollision(bullet, alien)) {
                        bullets.splice(i, 1); // Remove bullet
                        if (alien.takeDamage(bullet.damage)) {
                            // Alien destroyed
                            score += alien.scoreValue;
                            gold += alien.goldValue;
                            // Spawn a coin at alien's position
                            coins.push(new Coin(alien.x + alien.width / 2 - 12.5, alien.y + alien.height / 2 - 12.5, alien.goldValue));
                            aliens.splice(j, 1); // Remove alien
                            powerUpSpawnCounter++; // Increment counter for power-up spawning
                            if (powerUpSpawnCounter >= POWERUP_SPAWN_ALIEN_COUNT) {
                                spawnRandomPowerUp(alien.x, alien.y);
                                powerUpSpawnCounter = 0;
                            }
                            updateUI();
                            checkUpgradeButtonStates(); // Recheck upgrade buttons after earning gold
                        }
                        break; // Bullet hit an alien, no need to check other aliens for this bullet
                    }
                }

                // Check collision with Boss
                if (bossActive && boss && checkCollision(bullet, boss)) {
                    bullets.splice(i, 1); // Remove bullet
                    if (boss.takeDamage(bullet.damage)) {
                        // Boss destroyed
                        score += boss.scoreValue;
                        gold += boss.goldValue;
                        bossActive = false;
                        boss = null;
                        showMessage("Boss defeated! You earned a lot of gold!");
                        // Increase next boss spawn threshold
                        bossSpawnThreshold += 5000;
                        // Guarantee a power-up drop from boss
                        spawnRandomPowerUp(canvas.width / 2, canvas.height / 4);
                    }
                    updateUI();
                    checkUpgradeButtonStates();
                }
            }

            requestAnimationFrame(gameLoop); // Continue the loop
        }

        /**
         * Spawns a random power-up at the given coordinates.
         * @param {number} x X-coordinate for power-up spawn.
         * @param {number} y Y-coordinate for power-up spawn.
         */
        function spawnRandomPowerUp(x, y) {
            const randomType = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
            powerups.push(new PowerUp(x, y, randomType));
        }

        /**
         * Activates a collected power-up.
         * @param {object} type The power-up type object.
         */
        function activatePowerUp(type) {
            // Deactivate any existing power-up first
            if (activePowerUp) {
                showMessage(`${activePowerUp.type.name} power-up replaced by ${type.name}!`);
                player.isShielded = false; // Ensure shield is off if it was the previous power-up
            } else {
                showMessage(`Power-up collected: ${type.name}!`);
            }

            activePowerUp = { type: type, startTime: Date.now() };
            powerUpEndTime = Date.now() + type.duration;

            switch (type.effect) {
                case "shield":
                    player.isShielded = true;
                    break;
                // Rapid fire and gold magnet are handled in player.update() and gameLoop collision
            }
        }


        /**
         * Checks for collision between two rectangular objects.
         * Assumes objects have x, y, width, height properties.
         * @param {object} obj1
         * @param {object} obj2
         * @returns {boolean} True if collision occurs, false otherwise.
         */
        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }

        /**
         * Updates the score, gold, and health displays.
         */
        function updateUI() {
            scoreDisplay.textContent = score;
            goldDisplay.textContent = gold;
            healthDisplay.textContent = player.health;
            shipLevelDisplay.textContent = `Level ${player.currentShipIndex + 1}`;

            // Update current ship stats display in the info line
            currentShipName.textContent = playerShips[player.currentShipIndex].name;
            currentHealthStat.textContent = player.maxHealth;
            currentFirepowerStat.textContent = player.firepower;
            currentSpeedStat.textContent = player.speed;
        }

        /**
         * Displays a message in the message box.
         * @param {string} message The message to display.
         */
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
        }

        /**
         * Hides the message box.
         */
        function hideMessage() {
            messageBox.classList.remove('show');
        }

        /**
         * Handles game over state.
         */
        function gameOver() {
            gameActive = false;
            showMessage(`Game Over! Your final score: ${score}. You collected ${gold} gold. Click 'Start Game' to try again!`);
            startButton.style.display = 'block';
            // Reset canvas size and show game wrapper after a short delay for transition
            setTimeout(() => {
                canvas.classList.remove('fullscreen');
                canvas.style.opacity = '0'; // Fade out canvas
                canvas.width = 600; // Reset to default menu size
                canvas.height = 400;

                // Show game wrapper and footer with transition
                gameWrapper.style.display = 'flex';
                gameFooter.style.display = 'block';
                setTimeout(() => {
                    gameWrapper.classList.remove('hide');
                    gameWrapper.classList.add('show');
                    gameFooter.classList.remove('hide');
                    gameFooter.classList.add('show');
                }, 10); // Small delay to re-apply 'show' class after display is set

                // Re-display the currently owned ship in the selection area after game over
                viewedShipIndex = player.currentShipIndex;
                displayShipDetails(viewedShipIndex);
                updateUpgradeButtonCosts();
                checkUpgradeButtonStates();
            }, 500); // Small delay for visual effect
        }

        /**
         * Calculates the cost of an individual upgrade (health, firepower, speed) based on its type and current level.
         * @param {string} type The type of upgrade (e.g., 'health', 'firepower').
         * @returns {number} The calculated cost.
         */
        function getIndividualUpgradeCost(type) {
            return Math.floor(UPGRADE_BASE_COST[type] * Math.pow(UPGRADE_COST_MULTIPLIER, player.upgradeLevels[type]));
        }

        /**
         * Updates the cost displayed on upgrade buttons.
         */
        function updateUpgradeButtonCosts() {
            healthCostDisplay.textContent = getIndividualUpgradeCost('health');
            firepowerCostDisplay.textContent = getIndividualUpgradeCost('firepower');
            speedCostDisplay.textContent = getIndividualUpgradeCost('speed');

            const nextShipIndex = viewedShipIndex + 1;
            if (viewedShipIndex < playerShips.length - 1) { // If not the last ship
                newShipCostDisplay.textContent = playerShips[viewedShipIndex].cost; // Cost of the currently viewed ship
                buyNewShipBtn.style.display = 'flex'; // Show button if more ships available
            } else {
                newShipCostDisplay.textContent = 'MAX';
                buyNewShipBtn.style.display = 'none'; // Hide if no more ships
            }
        }

        /**
         * Checks and updates the enabled/disabled state of upgrade buttons.
         */
        function checkUpgradeButtonStates() {
            // Individual upgrades
            upgradeHealthBtn.disabled = gold < getIndividualUpgradeCost('health') || player.upgradeLevels.health >= MAX_INDIVIDUAL_UPGRADE_LEVEL || viewedShipIndex !== player.currentShipIndex;
            upgradeFirepowerBtn.disabled = gold < getIndividualUpgradeCost('firepower') || player.upgradeLevels.firepower >= MAX_INDIVIDUAL_UPGRADE_LEVEL || viewedShipIndex !== player.currentShipIndex;
            upgradeSpeedBtn.disabled = gold < getIndividualUpgradeCost('speed') || player.upgradeLevels.speed >= MAX_INDIVIDUAL_UPGRADE_LEVEL || viewedShipIndex !== player.currentShipIndex;

            // Update button text to "MAX" if maxed out
            if (player.upgradeLevels.health >= MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                healthCostDisplay.textContent = 'MAX';
            }
            if (player.upgradeLevels.firepower >= MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                firepowerCostDisplay.textContent = 'MAX';
            }
            if (player.upgradeLevels.speed >= MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                speedCostDisplay.textContent = 'MAX';
            }

            // New ship upgrade button logic
            if (viewedShipIndex === player.currentShipIndex) {
                 // If currently viewing the owned ship, disable buy button for it
                buyNewShipBtn.disabled = true;
                newShipCostDisplay.textContent = 'OWNED';
            } else if (viewedShipIndex < player.currentShipIndex) {
                // If viewing a previously owned ship, disable buy button
                buyNewShipBtn.disabled = true;
                newShipCostDisplay.textContent = 'OWNED';
            }
            else {
                // If viewing a future ship, enable/disable based on gold
                const cost = playerShips[viewedShipIndex].cost;
                buyNewShipBtn.disabled = gold < cost;
                newShipCostDisplay.textContent = cost;
            }

            // Navigation buttons
            prevShipBtn.disabled = viewedShipIndex === 0;
            nextShipBtn.disabled = viewedShipIndex === playerShips.length - 1;
        }

        /**
         * Displays the details of a specific ship in the upgrade section.
         * @param {number} index The index of the ship in the playerShips array.
         */
        function displayShipDetails(index) {
            const ship = playerShips[index];
            selectedShipImage.src = ship.src;
            selectedShipName.textContent = ship.name;

            // Calculate stats including potential individual upgrades if this were the current ship
            // For display purposes, show base stats of the viewed ship
            displayHealth.textContent = `${ship.baseHealth} HP`;
            displayFirepower.textContent = `${ship.baseFirepower} DMG`;
            displaySpeed.textContent = `${ship.baseSpeed} PX/S`;
            displayFireRate.textContent = `${ship.baseFireRate} MS`;

            // If the viewed ship is the currently owned ship, also show current individual upgrade levels
            if (index === player.currentShipIndex) {
                displayHealth.textContent += ` (+${player.upgradeLevels.health * 50})`;
                displayFirepower.textContent += ` (+${player.upgradeLevels.firepower * 5})`;
                displaySpeed.textContent += ` (+${player.upgradeLevels.speed * 1.5})`;
                displayFireRate.textContent += ` (Current: ${player.fireRate} MS)`;
            }

            // Update button states based on the *viewed* ship
            checkUpgradeButtonStates();
        }

        // --- Event Listeners ---

        // Keyboard input for player movement and shooting
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            // Prevent default spacebar action (scrolling)
            if (e.code === 'Space') {
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Touch input for player movement and shooting (simplified)
        let touchStartX = 0;
        let touchCurrentX = 0;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            if (e.touches.length > 0) {
                touchStartX = e.touches[0].clientX;
                // Simple tap to shoot
                if (gameActive && (Date.now() - player.lastShotTime > player.fireRate)) {
                    player.shoot();
                    player.lastShotTime = Date.now();
                }
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Prevent scrolling
            if (e.touches.length > 0) {
                touchCurrentX = e.touches[0].clientX;
                const deltaX = touchCurrentX - touchStartX;

                // Adjust player position based on touch movement
                if (gameActive) {
                    player.x += deltaX * 0.8; // Adjust sensitivity
                    // Keep player within bounds
                    if (player.x < 0) player.x = 0;
                    if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
                }
                touchStartX = touchCurrentX; // Update start for continuous movement
            }
        });

        canvas.addEventListener('touchend', () => {
            // No specific action on touchend for continuous movement
        });


        // Start Game button
        startButton.addEventListener('click', startGame);

        // Upgrade buttons
        upgradeHealthBtn.addEventListener('click', () => {
            const cost = getIndividualUpgradeCost('health');
            if (gold >= cost && player.upgradeLevels.health < MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                gold -= cost;
                player.upgradeLevels.health++;
                player.loadShipStats(); // Reapply stats to update maxHealth and current health
                player.heal(50); // Heal a bit on health upgrade
                showMessage(`Health upgraded! Current Max Health: ${player.maxHealth}.`);
            } else if (player.upgradeLevels.health >= MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                showMessage("Health upgrade is MAXED out for this ship!");
            } else {
                showMessage(`Not enough gold for Health upgrade! Need ${cost - gold} more.`);
            }
            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates();
            displayShipDetails(viewedShipIndex); // Update displayed stats
        });

        upgradeFirepowerBtn.addEventListener('click', () => {
            const cost = getIndividualUpgradeCost('firepower');
            if (gold >= cost && player.upgradeLevels.firepower < MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                gold -= cost;
                player.upgradeLevels.firepower++;
                player.loadShipStats();
                showMessage(`Firepower upgraded! Current Damage: ${player.firepower}, Fire Rate: ${player.fireRate}ms.`);
            } else if (player.upgradeLevels.firepower >= MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                showMessage("Firepower upgrade is MAXED out for this ship!");
            } else {
                showMessage(`Not enough gold for Firepower upgrade! Need ${cost - gold} more.`);
            }
            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates();
            displayShipDetails(viewedShipIndex); // Update displayed stats
        });

        upgradeSpeedBtn.addEventListener('click', () => {
            const cost = getIndividualUpgradeCost('speed');
            if (gold >= cost && player.upgradeLevels.speed < MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                gold -= cost;
                player.upgradeLevels.speed++;
                player.loadShipStats();
                showMessage(`Speed upgraded! Current Speed: ${player.speed}.`);
            } else if (player.upgradeLevels.speed >= MAX_INDIVIDUAL_UPGRADE_LEVEL) {
                showMessage("Speed upgrade is MAXED out for this ship!");
            } else {
                showMessage(`Not enough gold for Speed upgrade! Need ${cost - gold} more.`);
            }
            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates();
            displayShipDetails(viewedShipIndex); // Update displayed stats
        });

        buyNewShipBtn.addEventListener('click', () => {
            // This button now buys the `viewedShipIndex` if it's a new ship
            if (viewedShipIndex > player.currentShipIndex && viewedShipIndex < playerShips.length) {
                const cost = playerShips[viewedShipIndex].cost;
                if (gold >= cost) {
                    gold -= cost;
                    player.currentShipIndex = viewedShipIndex; // Set player's ship to the viewed one
                    player.upgradeLevels = { health: 0, firepower: 0, speed: 0 }; // Reset individual upgrades for new ship
                    player.loadShipStats(); // Load new ship's base stats and reset individual upgrades
                    player.health = player.maxHealth; // Fully heal on new ship purchase
                    showMessage(`Congratulations! You bought the ${playerShips[player.currentShipIndex].name}!`);
                } else {
                    showMessage(`Not enough gold to buy the ${playerShips[viewedShipIndex].name}! Need ${cost - gold} more.`);
                }
            } else {
                showMessage("You already own this ship or there are no more ships to buy!");
            }
            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates();
            displayShipDetails(viewedShipIndex); // Update displayed stats
        });

        // Ship navigation buttons
        prevShipBtn.addEventListener('click', () => {
            if (viewedShipIndex > 0) {
                viewedShipIndex--;
                displayShipDetails(viewedShipIndex);
            }
        });

        nextShipBtn.addEventListener('click', () => {
            if (viewedShipIndex < playerShips.length - 1) {
                viewedShipIndex++;
                displayShipDetails(viewedShipIndex);
            }
        });

        // Redeem Code functionality
        redeemCodeBtn.addEventListener('click', () => {
            const code = redeemCodeInput.value.trim().toUpperCase();
            if (code === "RAAJ") {
                gold += 1000;
                showMessage("Code 'RAAJ' redeemed! You received 1000 gold!");
            } else if (code === "TONY") {
                gold += 90000;
                showMessage("Code 'TONY' redeemed! You received 90000 gold! You're rich!");
            } else {
                showMessage("Invalid redeem code. Please try again.");
            }
            redeemCodeInput.value = ''; // Clear input
            updateUI();
            checkUpgradeButtonStates();
        });

        // --- Initial Setup ---
        window.onload = function() {
            preloadAssets(); // Start preloading images
        };

        // Adjust canvas size on window resize
        window.addEventListener('resize', () => {
            if (gameActive) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                // Adjust player position to stay centered if canvas resizes during game
                player.x = canvas.width / 2 - player.width / 2;
                player.y = canvas.height - player.height - 20;
            } else {
                // In menu mode, revert to fixed canvas size or responsive within wrapper
                const gameAreaWidth = gameWrapper.clientWidth - (2 * 16); // Wrapper padding 2rem = 32px, so 16px each side
                canvas.width = Math.min(600, gameAreaWidth); // Keep max width at 600px
                canvas.height = canvas.width * (400 / 600); // Maintain aspect ratio
            }
        });
    </script>
</body>
</html>

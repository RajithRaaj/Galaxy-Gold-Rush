<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Gold Rush!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the game */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background for space theme */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0; /* Remove padding for full screen on mobile */
            box-sizing: border-box;
            color: #e2e8f0; /* Light text color */
            overflow: hidden; /* Prevent scrolling */
            background-image: url('https://i.ibb.co/CpNDPHHG/Gemini-Generated-Image-rqajpfrqajpfrqaj.png'); /* Background image */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #e2e8f0;
            font-size: 2.5rem;
            font-weight: 800;
            z-index: 1000;
            transition: opacity 1s ease-out;
            opacity: 1;
        }

        .preloader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .watermark {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
        }

        .game-wrapper {
            background-color: rgba(45, 55, 72, 0.9); /* Darker gray for container with transparency */
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            text-align: center;
            max-width: 900px; /* Wider for game + upgrades */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative; /* For floating messages */
        }

        canvas {
            background-color: #000000; /* Black for space */
            border: 2px solid #4a5568; /* Subtle border */
            border-radius: 0.75rem;
            display: block;
            margin: 0 auto;
            touch-action: none; /* Disable default touch actions like scrolling/zooming */
            width: 100%; /* Make canvas responsive */
            height: 400px; /* Default height, will be adjusted by JS */
            image-rendering: pixelated; /* For crisp pixel art if used */
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #cbd5e0;
        }

        .upgrade-section, .items-section, .redeem-section {
            background-color: rgba(44, 62, 80, 0.8); /* Slightly different dark shade with transparency */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .upgrade-buttons, .item-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .game-button {
            background-color: #4a90e2; /* Blue for upgrades */
            color: white;
            font-weight: 700;
            padding: 0.8rem 1.2rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none; /* Remove default button border */
        }

        .game-button:hover:not(:disabled) {
            background-color: #357ABD;
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        .game-button:disabled {
            background-color: #4a5568; /* Gray out when disabled */
            cursor: not-allowed;
            opacity: 0.7;
        }

        .start-button {
            background-color: #48bb78; /* Green for start */
            color: white;
            font-weight: 800;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            border: none;
        }

        .start-button:hover {
            background-color: #38a169;
            transform: translateY(-3px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .message-box {
            background-color: #fefcbf;
            border: 1px solid #fbd38d;
            color: #975a16;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-weight: 600;
            display: none;
            position: relative;
            z-index: 10;
        }

        .message-box.show {
            display: block;
        }

        .floating-message {
            position: absolute;
            color: yellow;
            font-weight: bold;
            font-size: 1.2em;
            opacity: 0;
            animation: fadeOutUp 1.5s forwards;
            pointer-events: none; /* Allow clicks to pass through */
            text-shadow: 1px 1px 2px black;
        }

        @keyframes fadeOutUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        .redeem-input {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #4a5568;
            background-color: #2d3748;
            color: #e2e8f0;
            width: 100%;
            max-width: 300px;
            margin-right: 1rem;
        }

        .footer {
            margin-top: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .footer img {
            height: 30px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-wrapper {
                padding: 1.5rem;
                gap: 1rem;
                margin-top: 0; /* Remove top margin for mobile */
            }
            .game-stats {
                font-size: 1.1rem;
                gap: 0.75rem;
            }
            .upgrade-section, .items-section, .redeem-section {
                padding: 1rem;
            }
            .game-button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            h1 {
                font-size: 2rem;
            }
            canvas {
                height: 300px; /* Adjust height for smaller screens */
            }
        }

        @media (max-width: 480px) {
            .game-wrapper {
                padding: 1rem;
                border-radius: 0; /* No rounded corners on very small screens */
                box-shadow: none; /* No shadow on very small screens */
                min-height: 100vh; /* Make wrapper take full height */
                justify-content: space-between; /* Distribute content vertically */
            }
            h1 {
                font-size: 1.75rem;
            }
            .game-stats {
                font-size: 1rem;
                flex-direction: column;
            }
            .upgrade-buttons, .item-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .game-button {
                width: 100%;
            }
            .redeem-input {
                margin-right: 0;
                margin-bottom: 1rem;
            }
            .redeem-section .flex {
                flex-direction: column;
            }
            canvas {
                height: 250px; /* Further adjust height for very small screens */
            }
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">
    <div class="preloader" id="preloader">
        <p>COSMO ATTACK</p>
        <p class="text-lg mt-4">Loading Assets...</p>
        <a href="https://zenora-ai.vercel.app/" target="_blank" class="watermark">zenora-ai.vercel.app/</a>
    </div>

    <div class="game-wrapper hidden" id="gameWrapper">
        <h1 class="text-4xl font-extrabold text-white mb-4">Galactic Gold Rush!</h1>

        <div class="game-stats">
            <span>Score: <span id="scoreDisplay">0</span></span>
            <span>Gold: <span id="goldDisplay">0</span> üí∞</span>
            <span>Health: <span id="healthDisplay">100</span> ‚ù§Ô∏è</span>
        </div>

        <canvas id="gameCanvas" width="600" height="400"></canvas>

        <button id="startButton" class="start-button">Start Game</button>

        <div id="messageBox" class="message-box">
            Welcome, pilot! Destroy aliens, collect gold, and upgrade your ship! Use A/D or Left/Right arrows to move, Spacebar to shoot.
        </div>

        <div class="upgrade-section">
            <h2 class="text-2xl font-bold text-white mb-3">Ship Upgrades</h2>
            <div class="upgrade-buttons">
                <button id="upgradeShipBtn" class="game-button">
                    Upgrade Ship to Level <span id="shipLevelDisplay">2</span> (<span id="shipUpgradeCost">1000</span> üí∞)
                </button>
            </div>
            <p class="text-sm text-gray-400 mt-2" id="shipStatsInfo">Current Ship Stats: Health: 100, Firepower: 10, Speed: 5</p>

            <h2 class="text-2xl font-bold text-white mb-3 mt-4">Current Ship Stat Upgrades (Max 3 Levels)</h2>
            <div class="upgrade-buttons">
                <button id="upgradeHealthBtn" class="game-button">
                    Health (<span id="healthCost">50</span> üí∞)
                </button>
                <button id="upgradeFirepowerBtn" class="game-button">
                    Firepower (<span id="firepowerCost">75</span> üí∞)
                </button>
                <button id="upgradeSpeedBtn" class="game-button">
                    Speed (<span id="speedCost">60</span> üí∞)
                </button>
            </div>
        </div>

        <div class="items-section">
            <h2 class="text-2xl font-bold text-white mb-3">Items Shop</h2>
            <div class="item-buttons">
                <button id="buyCloneBtn" class="game-button">
                    Clone (500 üí∞) - Auto-shooting clone for 7s
                </button>
                <button id="buyShieldBtn" class="game-button">
                    Shield (300 üí∞) - Invincibility for 7s
                </button>
                <button id="buyBombBtn" class="game-button">
                    Bomb (700 üí∞) - Destroys all visible enemies
                </button>
                <button id="buyHealBtn" class="game-button">
                    Repair Kit (200 üí∞) - Restores 50 Health
                </button>
            </div>
        </div>

        <div class="redeem-section">
            <h2 class="text-2xl font-bold text-white mb-3">Redeem Code</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <input type="text" id="redeemCodeInput" placeholder="Enter code here" class="redeem-input">
                <button id="redeemCodeBtn" class="game-button bg-purple-600 hover:bg-purple-700">Redeem</button>
            </div>
        </div>

        <a href="https://tally.so/r/3x7Bl5" target="_blank" class="game-button bg-yellow-500 hover:bg-yellow-600 mx-auto mt-4 max-w-xs">
            Buy More Gold Online!
        </a>

        <footer class="footer">
            <img src="https://i.ibb.co/JRsMXc4G/Gemini-Generated-Image-gyfxkzgyfxkzgyfx.png" alt="Website Logo">
            <p>&copy; 2025 Galactic Gold Rush. All rights reserved.</p>
            <a href="https://zenora-ai.vercel.app/" target="_blank" class="watermark">zenora-ai.vercel.app/</a>
        </footer>
    </div>

    <script>
        // --- Preloader Elements ---
        const preloader = document.getElementById('preloader');
        const gameWrapper = document.getElementById('gameWrapper');

        // --- DOM Elements ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const goldDisplay = document.getElementById('goldDisplay');
        const healthDisplay = document.getElementById('healthDisplay');
        const startButton = document.getElementById('startButton');
        const messageBox = document.getElementById('messageBox');

        // Upgrade buttons
        const upgradeShipBtn = document.getElementById('upgradeShipBtn');
        const shipLevelDisplay = document.getElementById('shipLevelDisplay');
        const shipUpgradeCostDisplay = document.getElementById('shipUpgradeCost');
        const shipStatsInfo = document.getElementById('shipStatsInfo');

        const upgradeHealthBtn = document.getElementById('upgradeHealthBtn');
        const upgradeFirepowerBtn = document.getElementById('upgradeFirepowerBtn');
        const upgradeSpeedBtn = document.getElementById('upgradeSpeedBtn');

        const healthCostDisplay = document.getElementById('healthCost');
        const firepowerCostDisplay = document.getElementById('firepowerCost');
        const speedCostDisplay = document.getElementById('speedCost');

        // Item buttons
        const buyCloneBtn = document.getElementById('buyCloneBtn');
        const buyShieldBtn = document.getElementById('buyShieldBtn');
        const buyBombBtn = document.getElementById('buyBombBtn');
        const buyHealBtn = document.getElementById('buyHealBtn');

        // Redeem code elements
        const redeemCodeInput = document.getElementById('redeemCodeInput');
        const redeemCodeBtn = document.getElementById('redeemCodeBtn');

        // --- Game State Variables ---
        let gameActive = false;
        let score = 0;
        let gold = 0;
        let player = {}; // Player object
        let bullets = []; // Array to hold active player bullets
        let alienBullets = []; // Array to hold active alien/boss bullets
        let aliens = [];  // Array to hold active aliens
        let bosses = []; // Array to hold active bosses
        let coins = [];   // Array to hold active coins
        let clones = []; // Array to hold active clones

        let keys = {}; // Object to track pressed keys for smooth movement

        // Game difficulty and spawning
        let currentWave = 0;
        let aliensPerWave = 5; // Initial aliens per wave
        let alienSpawnInterval = 1000; // Milliseconds between alien spawns within a wave
        let lastAlienSpawnTime = 0;
        let gameSpeedMultiplier = 1; // Increases over time for difficulty

        // Upgrade costs and levels for individual stats (max 3 levels)
        const STAT_UPGRADE_BASE_COST = {
            health: 50,
            firepower: 75,
            speed: 60,
        };
        const STAT_UPGRADE_COST_MULTIPLIER = 2; // Cost increases by this factor each level
        const MAX_STAT_UPGRADE_LEVEL = 3;

        let statUpgradeLevels = {
            health: 0,
            firepower: 0,
            speed: 0,
        };

        // Ship upgrade levels and costs
        let currentShipLevel = 0; // 0-indexed, so Level 1 is index 0
        const SHIP_UPGRADES = [
            {
                name: "Basic Ship",
                image: 'https://i.ibb.co/Zp91vZM1/Add-a-subheading-3-removebg-preview.png',
                baseHealth: 100,
                baseFirepower: 10,
                baseSpeed: 5,
                baseFireRate: 300,
                cost: 0 // No cost for initial ship
            },
            {
                name: "Scout MK-II",
                image: 'https://i.ibb.co/5gN4kQPm/Add-a-subheading-4-removebg-preview.png',
                baseHealth: 150,
                baseFirepower: 15,
                baseSpeed: 7,
                baseFireRate: 250,
                cost: 1000
            },
            {
                name: "Interceptor X",
                image: 'https://i.ibb.co/XxxmMMYG/Add-a-subheading-5-removebg-preview.png',
                baseHealth: 200,
                baseFirepower: 20,
                baseSpeed: 9,
                baseFireRate: 200,
                cost: 3000
            },
            {
                name: "Vanguard Elite",
                image: 'https://i.ibb.co/ns63zjhR/Add-a-subheading-6-removebg-preview.png',
                baseHealth: 275,
                baseFirepower: 28,
                baseSpeed: 11,
                baseFireRate: 180,
                cost: 7000
            },
            {
                name: "Star Destroyer",
                image: 'https://i.ibb.co/0yBxnkXc/Add-a-subheading-7-removebg-preview.png',
                baseHealth: 350,
                baseFirepower: 35,
                baseSpeed: 13,
                baseFireRate: 150,
                cost: 15000
            },
            {
                name: "Galactic Conqueror",
                image: 'https://i.ibb.co/LmryyQX/Add-a-subheading-8-removebg-preview.png',
                baseHealth: 500,
                baseFirepower: 50,
                baseSpeed: 15,
                baseFireRate: 100,
                cost: 30000
            }
        ];

        const ALIEN_IMAGES = [
            'https://i.ibb.co/H1wtjD3/21-removebg-preview.png',
            'https://i.ibb.co/qYZDjdYK/22-removebg-preview.png',
            'https://i.ibb.co/Sk0S6Ln/23-removebg-preview.png',
            'https://i.ibb.co/nZMTxSJ/24-removebg-preview.png',
            'https://i.ibb.co/5WmmmJBg/25-removebg-preview.png',
            'https://i.ibb.co/bMfTXBPs/26-removebg-preview.png'
        ];

        const BOSS_IMAGES = [
            'https://i.ibb.co/60tHqjVH/29-removebg-preview.png',
            'https://i.ibb.co/yc594vt1/28-removebg-preview.png',
            'https://i.ibb.co/cSGZdHtc/30-removebg-preview.png',
            'https://i.ibb.co/5WyDghFc/27-removebg-preview.png',
            'https://i.ibb.co/tTV2TGgB/32-removebg-preview.png',
            'https://i.ibb.co/FT0nGkd/31-removebg-preview.png'
        ];

        const ALL_IMAGE_URLS = [
            ...SHIP_UPGRADES.map(s => s.image),
            ...ALIEN_IMAGES,
            ...BOSS_IMAGES,
            'https://i.ibb.co/CpNDPHHG/Gemini-Generated-Image-rqajpfrqajpfrqaj.png', // Background
            'https://i.ibb.co/JRsMXc4G/Gemini-Generated-Image-gyfxkzgyfxkzgyfx.png' // Footer Logo
        ];
        let loadedImages = {}; // Cache for loaded images

        // Items state
        let activeItems = {
            clone: { active: false, timer: 0 },
            shield: { active: false, timer: 0 },
        };
        const ITEM_DURATION = 7000; // 7 seconds in milliseconds

        // --- Game Entities (Classes) ---

        /**
         * Loads an image and returns a Promise that resolves with the Image object.
         * Caches loaded images to prevent redundant loading.
         * @param {string} url The URL of the image.
         * @returns {Promise<HTMLImageElement>} A promise that resolves with the loaded Image object.
         */
        function loadImage(url) {
            if (loadedImages[url]) {
                return Promise.resolve(loadedImages[url]);
            }
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    loadedImages[url] = img;
                    resolve(img);
                };
                img.onerror = () => {
                    console.error(`Failed to load image: ${url}`);
                    // Provide a fallback placeholder image
                    const placeholder = new Image();
                    placeholder.src = `https://placehold.co/50x50/cccccc/000000?text=IMG`;
                    placeholder.onload = () => {
                        loadedImages[url] = placeholder;
                        resolve(placeholder);
                    };
                    placeholder.onerror = () => reject(new Error(`Failed to load placeholder for ${url}`));
                };
            });
        }

        /**
         * Base class for game entities that have positions, dimensions, and can be drawn with an image.
         */
        class GameEntity {
            constructor(x, y, width, height, imageUrl, speed = 0, health = 1) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.speed = speed;
                this.health = health;
                this.maxHealth = health;
                this.image = loadedImages[imageUrl]; // Image object
            }

            draw() {
                if (this.image) {
                    ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                } else {
                    // Fallback to a colored rectangle if image fails to load
                    ctx.fillStyle = 'red';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }
            }

            update() {
                // To be overridden by subclasses
            }

            /**
             * Checks for collision between this entity and another rectangular object.
             * Assumes objects have x, y, width, height properties.
             * @param {object} otherObj
             * @returns {boolean} True if collision occurs, false otherwise.
             */
            checkCollision(otherObj) {
                return this.x < otherObj.x + otherObj.width &&
                       this.x + this.width > otherObj.x &&
                       this.y < otherObj.y + otherObj.height &&
                       this.y + this.height > otherObj.y;
            }
        }

        /**
         * Represents the player's spaceship.
         */
        class Player extends GameEntity {
            constructor(shipConfig) {
                super(
                    canvas.width / 2 - 40 / 2, // Initial width 40
                    canvas.height - 40 - 20, // Initial height 40
                    40, // Base width, will be updated by applyUpgrades
                    40, // Base height, will be updated by applyUpgrades
                    shipConfig.image,
                    shipConfig.baseSpeed,
                    shipConfig.baseHealth
                );
                this.baseWidth = 40;
                this.baseHeight = 40;
                this.firepower = shipConfig.baseFirepower;
                this.fireRate = shipConfig.baseFireRate;
                this.lastShotTime = 0;
                this.isShielded = false;
                this.isClone = false; // To differentiate main player from clone
            }

            /**
             * Updates player position based on key presses or touch input.
             */
            update() {
                if (keys['ArrowLeft'] || keys['a']) {
                    this.x -= this.speed;
                }
                if (keys['ArrowRight'] || keys['d']) {
                    this.x += this.speed;
                }

                // Keep player within canvas bounds
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;

                // Automatic shooting
                if (Date.now() - this.lastShotTime > this.fireRate) {
                    this.shoot();
                    this.lastShotTime = Date.now();
                }
            }

            /**
             * Creates a new bullet and adds it to the bullets array.
             */
            shoot() {
                bullets.push(new Bullet(this.x + this.width / 2 - 5, this.y, this.firepower));
            }

            /**
             * Reduces player health.
             * @param {number} damage The amount of damage to take.
             */
            takeDamage(damage) {
                if (this.isShielded) {
                    showFloatingMessage("Shield Active!", this.x + this.width / 2, this.y, 'cyan');
                    return;
                }
                this.health -= damage;
                if (this.health <= 0) {
                    this.health = 0;
                    gameOver();
                }
                updateUI();
                showFloatingMessage(`-${damage} HP`, this.x + this.width / 2, this.y, 'red');
            }

            /**
             * Heals the player up to max health.
             * @param {number} amount The amount to heal.
             */
            heal(amount) {
                this.health = Math.min(this.maxHealth, this.health + amount);
                updateUI();
                showFloatingMessage(`+${amount} HP`, this.x + this.width / 2, this.y, 'lime');
            }
        }

        /**
         * Represents a bullet fired by the player.
         */
        class Bullet extends GameEntity {
            constructor(x, y, damage) {
                super(x, y, 10, 20, null, 10); // No image for bullets, use emoji
                this.damage = damage;
                this.emoji = '‚ö°';
            }

            draw() {
                ctx.font = `${this.height}px Arial`;
                ctx.fillText(this.emoji, this.x, this.y);
            }

            update() {
                this.y -= this.speed;
            }
        }

        /**
         * Represents a bullet fired by an alien or boss.
         */
        class AlienBullet extends GameEntity {
            constructor(x, y, damage) {
                super(x, y, 10, 20, null, 5); // Speed for alien bullets
                this.damage = damage;
                this.emoji = 'üî¥'; // Red dot for alien bullets
            }

            draw() {
                ctx.font = `${this.height}px Arial`;
                ctx.fillText(this.emoji, this.x, this.y);
            }

            update() {
                this.y += this.speed;
            }
        }

        /**
         * Represents an alien enemy.
         */
        class Alien extends GameEntity {
            constructor(x, y, level) {
                const alienImage = ALIEN_IMAGES[Math.min(level, ALIEN_IMAGES.length - 1)];
                const width = 35 + (level * 2);
                const height = 35 + (level * 2);
                const baseHealth = 20 + (level * 5);
                const baseSpeed = 1 + (level * 0.2);
                super(x, y, width, height, alienImage, baseSpeed * gameSpeedMultiplier, baseHealth);
                this.goldValue = 10 + (level * 2);
                this.scoreValue = 100 + (level * 20);
                this.fireRate = 1500 - (level * 50); // Aliens shoot faster at higher levels
                this.lastShotTime = Date.now();
                this.isBoss = false;
            }

            update() {
                this.y += this.speed;
                // Aliens now stay on screen and shoot
                if (this.y + this.height > canvas.height / 3 && this.y < canvas.height / 2) { // Stay in upper middle
                    this.y = Math.max(this.y, canvas.height / 3); // Prevent going too low
                    this.y = Math.min(this.y, canvas.height / 2); // Prevent going too high
                    if (Date.now() - this.lastShotTime > this.fireRate) {
                        this.shoot();
                        this.lastShotTime = Date.now();
                    }
                }
            }

            shoot() {
                alienBullets.push(new AlienBullet(this.x + this.width / 2 - 5, this.y + this.height, 1)); // Damage 1
            }

            /**
             * Reduces alien health.
             * @param {number} damage The amount of damage to take.
             * @returns {boolean} True if the alien is destroyed, false otherwise.
             */
            takeDamage(damage) {
                this.health -= damage;
                if (this.health <= 0) {
                    return true; // Alien destroyed
                }
                return false;
            }
        }

        /**
         * Represents a boss enemy.
         */
        class Boss extends Alien {
            constructor(x, y, level) {
                const bossImage = BOSS_IMAGES[Math.min(level, BOSS_IMAGES.length - 1)];
                const width = 80 + (level * 10);
                const height = 80 + (level * 10);
                const baseHealth = 200 + (level * 50); // Bosses are much tougher
                const baseSpeed = 0.5 + (level * 0.1); // Bosses move slower but are tanky
                super(x, y, level); // Call alien constructor for basic properties
                this.image = loadedImages[bossImage]; // Override image
                this.width = width;
                this.height = height;
                this.health = baseHealth;
                this.maxHealth = baseHealth;
                this.speed = baseSpeed * gameSpeedMultiplier;
                this.goldValue = 500 + (level * 100);
                this.scoreValue = 5000 + (level * 1000);
                this.fireRate = 800 - (level * 50); // Bosses shoot faster
                this.isBoss = true;
                this.movementDirection = 1; // 1 for right, -1 for left
            }

            update() {
                // Bosses move horizontally and shoot
                this.x += this.speed * this.movementDirection;

                if (this.x + this.width > canvas.width || this.x < 0) {
                    this.movementDirection *= -1; // Reverse direction
                }

                // Bosses stay in the top part of the screen
                if (this.y < canvas.height / 4) {
                    this.y += this.speed * 0.5; // Slowly move down to position
                } else {
                    this.y = canvas.height / 4; // Stay at this Y position
                }

                if (Date.now() - this.lastShotTime > this.fireRate) {
                    this.shoot();
                    this.lastShotTime = Date.now();
                }
            }

            shoot() {
                // Bosses can shoot multiple bullets or more powerful ones
                alienBullets.push(new AlienBullet(this.x + this.width / 4, this.y + this.height, 2)); // Damage 2
                alienBullets.push(new AlienBullet(this.x + this.width * 3 / 4, this.y + this.height, 2)); // Damage 2
            }
        }


        /**
         * Represents a gold coin.
         */
        class Coin extends GameEntity {
            constructor(x, y, value) {
                super(x, y, 25, 25, null, 3); // No image for coins, use emoji
                this.value = value;
                this.emoji = 'ÔøΩ';
            }

            draw() {
                ctx.font = `${this.height}px Arial`;
                ctx.fillText(this.emoji, this.x, this.y + this.height);
            }

            update() {
                this.y += this.speed;
            }
        }

        // --- Game Functions ---

        /**
         * Initializes or resets the game state.
         */
        function initializeGame() {
            gameActive = false;
            score = 0;
            gold = 0;
            bullets = [];
            alienBullets = [];
            aliens = [];
            bosses = [];
            coins = [];
            clones = [];
            keys = {};
            currentWave = 0; // Reset wave counter
            alienSpawnInterval = 1000;
            lastAlienSpawnTime = 0;
            gameSpeedMultiplier = 1;

            // Reset upgrade levels and costs for stats
            statUpgradeLevels = {
                health: 0,
                firepower: 0,
                speed: 0,
            };
            currentShipLevel = 0; // Reset ship to basic

            // Set canvas size to fit mobile screen
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            player = new Player(SHIP_UPGRADES[currentShipLevel]); // Create new player instance with basic ship
            applyUpgrades(); // Apply initial ship stats

            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates();
            messageBox.textContent = "Welcome, pilot! Destroy enemies, collect gold, and upgrade your ship! Use A/D or Left/Right arrows to move. Your ship shoots automatically!";
            messageBox.classList.add('show');
            startButton.style.display = 'block';
            gameWrapper.classList.remove('hidden'); // Show game wrapper after initialization
        }

        /**
         * Adjusts canvas size to fill available screen space, especially for mobile.
         */
        function resizeCanvas() {
            canvas.width = window.innerWidth > 900 ? 800 : window.innerWidth * 0.9; // Max 800px, or 90% of width
            canvas.height = window.innerHeight * 0.5; // Take 50% of screen height
            player.x = canvas.width / 2 - player.width / 2; // Reposition player
            player.y = canvas.height - player.height - 20;
        }

        /**
         * Starts the main game loop.
         */
        function startGame() {
            gameActive = true;
            score = 0;
            gold = 0;
            bullets = [];
            alienBullets = [];
            aliens = [];
            bosses = [];
            coins = [];
            clones = []; // Clear clones
            keys = {};
            currentWave = 0; // Start from wave 0
            alienSpawnInterval = 1000;
            lastAlienSpawnTime = Date.now(); // Reset spawn timer
            gameSpeedMultiplier = 1;

            // Reset player and apply current ship/stat upgrades
            player = new Player(SHIP_UPGRADES[currentShipLevel]);
            applyUpgrades(); // Ensure all upgrades are applied to the new player instance

            updateUI();
            updateUpgradeButtonCosts();
            checkUpgradeButtonStates(); // Ensure buttons are correct at start
            messageBox.classList.remove('show');
            startButton.style.display = 'none';

            gameLoop(); // Start the game loop
        }

        /**
         * The main game loop, updates game state and redraws elements.
         */
        function gameLoop() {
            if (!gameActive) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

            const currentTime = Date.now();

            // --- Player Update ---
            player.update();
            player.draw();

            // --- Clones Update ---
            for (let i = clones.length - 1; i >= 0; i--) {
                const clone = clones[i];
                clone.update(); // Clones also auto-shoot
                clone.draw();
                if (currentTime > clone.deactivationTime) {
                    clones.splice(i, 1); // Remove clone after duration
                }
            }

            // --- Player Bullet Updates ---
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.update();
                bullet.draw();

                // Remove bullets that go off-screen
                if (bullet.y < 0) {
                    bullets.splice(i, 1);
                }
            }

            // --- Alien Bullet Updates ---
            for (let i = alienBullets.length - 1; i >= 0; i--) {
                const alienBullet = alienBullets[i];
                alienBullet.update();
                alienBullet.draw();

                // Check collision with player
                if (player.checkCollision(alienBullet)) {
                    player.takeDamage(alienBullet.damage);
                    alienBullets.splice(i, 1);
                    continue;
                }

                // Remove bullets that go off-screen
                if (alienBullet.y > canvas.height) {
                    alienBullets.splice(i, 1);
                }
            }

            // --- Alien Spawning and Updates ---
            if (aliens.length === 0 && bosses.length === 0) {
                // All aliens/bosses from previous wave defeated, start new wave
                currentWave++;
                messageBox.textContent = `Wave ${currentWave} incoming!`;
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), 2000);

                if (currentWave % 5 === 0) { // Every 5th wave is a boss wave
                    const bossX = Math.random() * (canvas.width - 100); // Boss width is larger
                    bosses.push(new Boss(bossX, -150, currentWave / 5 - 1)); // Boss level based on wave
                } else {
                    // Spawn new aliens
                    for (let i = 0; i < aliensPerWave + (currentWave * 0.5); i++) { // More aliens per wave
                        const alienX = Math.random() * (canvas.width - 40);
                        aliens.push(new Alien(alienX, -40 - (i * 60), Math.floor(currentWave / 2))); // Alien level based on wave
                    }
                    // Increase overall game speed and alien spawn interval for next wave
                    gameSpeedMultiplier += 0.01;
                    alienSpawnInterval = Math.max(300, alienSpawnInterval - 20); // Min interval 300ms
                }
            }

            // Update and draw aliens
            for (let i = aliens.length - 1; i >= 0; i--) {
                const alien = aliens[i];
                alien.update();
                alien.draw();
            }

            // Update and draw bosses
            for (let i = bosses.length - 1; i >= 0; i--) {
                const boss = bosses[i];
                boss.update();
                boss.draw();
            }

            // --- Coin Updates ---
            for (let i = coins.length - 1; i >= 0; i--) {
                const coin = coins[i];
                coin.update();
                coin.draw();

                // Check collision with player to collect coin
                if (player.checkCollision(coin)) {
                    gold += coin.value;
                    coins.splice(i, 1); // Remove coin
                    updateUI();
                    checkUpgradeButtonStates(); // Recheck upgrade buttons after collecting gold
                    showFloatingMessage(`+${coin.value} Gold`, coin.x, coin.y, 'gold');
                    continue;
                }

                // Remove coins that go off-screen
                if (coin.y > canvas.height) {
                    coins.splice(i, 1);
                }
            }

            // --- Collision Detection (Player Bullets vs Aliens/Bosses) ---
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                // Check aliens
                for (let j = aliens.length - 1; j >= 0; j--) {
                    const alien = aliens[j];
                    if (bullet.checkCollision(alien)) {
                        bullets.splice(i, 1); // Remove bullet
                        if (alien.takeDamage(bullet.damage)) {
                            score += alien.scoreValue;
                            gold += alien.goldValue;
                            coins.push(new Coin(alien.x + alien.width / 2 - 12.5, alien.y + alien.height / 2 - 12.5, alien.goldValue));
                            aliens.splice(j, 1); // Remove alien
                            updateUI();
                            checkUpgradeButtonStates();
                            showFloatingMessage(`+${alien.scoreValue} Score`, alien.x, alien.y - 20, 'white');
                        }
                        break; // Bullet hit an alien, no need to check other aliens for this bullet
                    }
                }
                // Check bosses
                for (let j = bosses.length - 1; j >= 0; j--) {
                    const boss = bosses[j];
                    if (bullet.checkCollision(boss)) {
                        bullets.splice(i, 1); // Remove bullet
                        if (boss.takeDamage(bullet.damage)) {
                            score += boss.scoreValue;
                            gold += boss.goldValue;
                            coins.push(new Coin(boss.x + boss.width / 2 - 12.5, boss.y + boss.height / 2 - 12.5, boss.goldValue));
                            bosses.splice(j, 1); // Remove boss
                            updateUI();
                            checkUpgradeButtonStates();
                            showFloatingMessage(`BOSS DEFEATED! +${boss.scoreValue} Score`, boss.x + boss.width / 2, boss.y - 20, 'gold');
                        }
                        break; // Bullet hit a boss
                    }
                }
            }

            // --- Item Effects Update ---
            if (activeItems.clone.active && currentTime > activeItems.clone.timer) {
                activeItems.clone.active = false;
                clones = []; // Clear clones
                showFloatingMessage("Clone expired!", player.x + player.width / 2, player.y, 'orange');
            }
            if (activeItems.shield.active && currentTime > activeItems.shield.timer) {
                activeItems.shield.active = false;
                player.isShielded = false;
                showFloatingMessage("Shield expired!", player.x + player.width / 2, player.y, 'orange');
            }

            requestAnimationFrame(gameLoop); // Continue the loop
        }

        /**
         * Shows a temporary floating message on the canvas.
         * @param {string} text The message to display.
         * @param {number} x X-coordinate.
         * @param {number} y Y-coordinate.
         * @param {string} color Text color.
         */
        function showFloatingMessage(text, x, y, color) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('floating-message');
            messageDiv.textContent = text;
            messageDiv.style.left = `${x}px`;
            messageDiv.style.top = `${y}px`;
            messageDiv.style.color = color;
            gameWrapper.appendChild(messageDiv);

            // Remove after animation
            messageDiv.addEventListener('animationend', () => {
                messageDiv.remove();
            });
        }


        /**
         * Updates the score, gold, and health displays.
         */
        function updateUI() {
            scoreDisplay.textContent = score;
            goldDisplay.textContent = gold;
            healthDisplay.textContent = player.health;
        }

        /**
         * Handles game over state.
         */
        function gameOver() {
            gameActive = false;
            messageBox.textContent = `Game Over! Your final score: ${score}. You collected ${gold} gold. Click 'Start Game' to try again!`;
            messageBox.classList.add('show');
            startButton.style.display = 'block';
            clones = []; // Clear any active clones
        }

        /**
         * Calculates the cost of a stat upgrade based on its type and current level.
         * @param {string} type The type of upgrade (e.g., 'health', 'firepower').
         * @returns {number|string} The calculated cost or "MAX".
         */
        function getStatUpgradeCost(type) {
            if (statUpgradeLevels[type] >= MAX_STAT_UPGRADE_LEVEL) {
                return "MAX";
            }
            return Math.floor(STAT_UPGRADE_BASE_COST[type] * Math.pow(STAT_UPGRADE_COST_MULTIPLIER, statUpgradeLevels[type]));
        }

        /**
         * Updates the cost displayed on upgrade buttons.
         */
        function updateUpgradeButtonCosts() {
            // Ship upgrade button
            if (currentShipLevel < SHIP_UPGRADES.length - 1) {
                const nextShip = SHIP_UPGRADES[currentShipLevel + 1];
                shipLevelDisplay.textContent = currentShipLevel + 2; // Next level is current + 2 (since 0-indexed)
                shipUpgradeCostDisplay.textContent = nextShip.cost;
                upgradeShipBtn.disabled = gold < nextShip.cost;
                shipStatsInfo.textContent = `Current Ship: ${SHIP_UPGRADES[currentShipLevel].name} (Lvl ${currentShipLevel + 1}) - Health: ${player.maxHealth}, Firepower: ${player.firepower}, Speed: ${player.speed}. Next Ship (${nextShip.name}): Health: ${nextShip.baseHealth + (MAX_STAT_UPGRADE_LEVEL * 25)}, Firepower: ${nextShip.baseFirepower + (MAX_STAT_UPGRADE_LEVEL * 5)}, Speed: ${nextShip.baseSpeed + (MAX_STAT_UPGRADE_LEVEL * 1.5)}`;
            } else {
                shipLevelDisplay.textContent = "MAX";
                shipUpgradeCostDisplay.textContent = "N/A";
                upgradeShipBtn.disabled = true;
                shipStatsInfo.textContent = `Current Ship: ${SHIP_UPGRADES[currentShipLevel].name} (Lvl ${currentShipLevel + 1}) - MAXED OUT!`;
            }

            // Stat upgrade buttons
            healthCostDisplay.textContent = getStatUpgradeCost('health');
            firepowerCostDisplay.textContent = getStatUpgradeCost('firepower');
            speedCostDisplay.textContent = getStatUpgradeCost('speed');
        }

        /**
         * Checks and updates the enabled/disabled state of upgrade buttons.
         */
        function checkUpgradeButtonStates() {
            // Ship upgrade button state is handled in updateUpgradeButtonCosts
            const healthCost = getStatUpgradeCost('health');
            upgradeHealthBtn.disabled = (healthCost === "MAX" || gold < healthCost);

            const firepowerCost = getStatUpgradeCost('firepower');
            upgradeFirepowerBtn.disabled = (firepowerCost === "MAX" || gold < firepowerCost);

            const speedCost = getStatUpgradeCost('speed');
            upgradeSpeedBtn.disabled = (speedCost === "MAX" || gold < speedCost);

            // Item buttons
            buyCloneBtn.disabled = gold < 500;
            buyShieldBtn.disabled = gold < 300;
            buyBombBtn.disabled = gold < 700;
            buyHealBtn.disabled = gold < 200;
        }

        /**
         * Applies all current upgrades to the player.
         * This function is called at the start of the game and after each upgrade.
         */
        function applyUpgrades() {
            // Apply base stats from current ship level
            const currentShipConfig = SHIP_UPGRADES[currentShipLevel];
            player.image = loadedImages[currentShipConfig.image]; // Update player image
            player.width = player.baseWidth; // Reset width/height before applying size upgrades
            player.height = player.baseHeight;

            player.speed = currentShipConfig.baseSpeed;
            player.firepower = currentShipConfig.baseFirepower;
            player.fireRate = currentShipConfig.baseFireRate;
            player.maxHealth = currentShipConfig.baseHealth;
            player.health = Math.min(player.health, player.maxHealth); // Cap current health to new max

            // Apply individual stat upgrades (additive to ship base stats)
            player.maxHealth += statUpgradeLevels.health * 25; // +25 max health per level
            player.health = Math.min(player.maxHealth, player.health + (statUpgradeLevels.health * 25)); // Also heal by the amount of max health gained
            player.firepower += statUpgradeLevels.firepower * 5; // +5 damage per level
            player.fireRate = Math.max(50, player.fireRate - (statUpgradeLevels.firepower * 20)); // Decrease fire rate (faster shooting)
            player.speed += statUpgradeLevels.speed * 1.5; // +1.5 speed per level

            // Player size is fixed for now, not affected by upgrades
            // player.width = player.baseWidth + (statUpgradeLevels.size * 10);
            // player.height = player.baseHeight + (statUpgradeLevels.size * 10);

            updateUI();
        }

        // --- Event Listeners ---

        // Keyboard input for player movement
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Touch input for player movement (simplified swipe)
        let touchStartX = 0;
        let touchCurrentX = 0;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            if (e.touches.length > 0) {
                touchStartX = e.touches[0].clientX;
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Prevent scrolling
            if (e.touches.length > 0) {
                touchCurrentX = e.touches[0].clientX;
                const deltaX = touchCurrentX - touchStartX;

                if (gameActive) {
                    player.x += deltaX * 0.8; // Adjust sensitivity
                    // Keep player within bounds
                    if (player.x < 0) player.x = 0;
                    if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
                }
                touchStartX = touchCurrentX; // Update start for continuous movement
            }
        });

        // Start Game button
        startButton.addEventListener('click', startGame);

        // --- Upgrade Buttons ---
        upgradeShipBtn.addEventListener('click', () => {
            if (currentShipLevel < SHIP_UPGRADES.length - 1) {
                const nextShipConfig = SHIP_UPGRADES[currentShipLevel + 1];
                const cost = nextShipConfig.cost;
                if (gold >= cost) {
                    gold -= cost;
                    currentShipLevel++;
                    // Reset individual stat upgrades when new ship is purchased
                    statUpgradeLevels = { health: 0, firepower: 0, speed: 0 };
                    player = new Player(SHIP_UPGRADES[currentShipLevel]); // Recreate player with new ship base stats
                    applyUpgrades(); // Apply new ship stats and reset stat upgrades
                    updateUpgradeButtonCosts();
                    checkUpgradeButtonStates();
                    updateUI();
                    messageBox.textContent = `Upgraded to ${nextShipConfig.name}! Stats improved!`;
                    messageBox.classList.add('show');
                } else {
                    messageBox.textContent = `Not enough gold for ${nextShipConfig.name}! Need ${cost - gold} more.`;
                    messageBox.classList.add('show');
                }
            }
        });

        upgradeHealthBtn.addEventListener('click', () => {
            const cost = getStatUpgradeCost('health');
            if (cost !== "MAX" && gold >= cost) {
                gold -= cost;
                statUpgradeLevels.health++;
                applyUpgrades();
                updateUpgradeButtonCosts();
                checkUpgradeButtonStates();
                updateUI();
                messageBox.textContent = `Health upgraded! Current Max Health: ${player.maxHealth}.`;
                messageBox.classList.add('show');
            } else if (cost === "MAX") {
                messageBox.textContent = `Health upgrade is MAXED OUT!`;
                messageBox.classList.add('show');
            } else {
                messageBox.textContent = `Not enough gold for Health upgrade! Need ${cost - gold} more.`;
                messageBox.classList.add('show');
            }
        });

        upgradeFirepowerBtn.addEventListener('click', () => {
            const cost = getStatUpgradeCost('firepower');
            if (cost !== "MAX" && gold >= cost) {
                gold -= cost;
                statUpgradeLevels.firepower++;
                applyUpgrades();
                updateUpgradeButtonCosts();
                checkUpgradeButtonStates();
                updateUI();
                messageBox.textContent = `Firepower upgraded! Current Damage: ${player.firepower}. Fire Rate: ${player.fireRate}ms`;
                messageBox.classList.add('show');
            } else if (cost === "MAX") {
                messageBox.textContent = `Firepower upgrade is MAXED OUT!`;
                messageBox.classList.add('show');
            } else {
                messageBox.textContent = `Not enough gold for Firepower upgrade! Need ${cost - gold} more.`;
                messageBox.classList.add('show');
            }
        });

        upgradeSpeedBtn.addEventListener('click', () => {
            const cost = getStatUpgradeCost('speed');
            if (cost !== "MAX" && gold >= cost) {
                gold -= cost;
                statUpgradeLevels.speed++;
                applyUpgrades();
                updateUpgradeButtonCosts();
                checkUpgradeButtonStates();
                updateUI();
                messageBox.textContent = `Speed upgraded! Current Speed: ${player.speed}.`;
                messageBox.classList.add('show');
            } else if (cost === "MAX") {
                messageBox.textContent = `Speed upgrade is MAXED OUT!`;
                messageBox.classList.add('show');
            } else {
                messageBox.textContent = `Not enough gold for Speed upgrade! Need ${cost - gold} more.`;
                messageBox.classList.add('show');
            }
        });

        // --- Item Buttons ---
        buyCloneBtn.addEventListener('click', () => {
            const cost = 500;
            if (gold >= cost) {
                gold -= cost;
                activeItems.clone.active = true;
                activeItems.clone.timer = Date.now() + ITEM_DURATION;
                // Create clone instance
                const clonePlayer = new Player(SHIP_UPGRADES[currentShipLevel]);
                clonePlayer.isClone = true;
                clonePlayer.x = player.x - 60; // Position clone to the left
                clonePlayer.y = player.y;
                clonePlayer.deactivationTime = activeItems.clone.timer; // When to remove
                clones.push(clonePlayer);

                // Create another clone instance to the right
                const clonePlayer2 = new Player(SHIP_UPGRADES[currentShipLevel]);
                clonePlayer2.isClone = true;
                clonePlayer2.x = player.x + 60; // Position clone to the right
                clonePlayer2.y = player.y;
                clonePlayer2.deactivationTime = activeItems.clone.timer; // When to remove
                clones.push(clonePlayer2);

                updateUI();
                checkUpgradeButtonStates();
                messageBox.textContent = `Clone activated for 7 seconds!`;
                messageBox.classList.add('show');
            } else {
                messageBox.textContent = `Not enough gold for Clone! Need ${cost - gold} more.`;
                messageBox.classList.add('show');
            }
        });

        buyShieldBtn.addEventListener('click', () => {
            const cost = 300;
            if (gold >= cost) {
                gold -= cost;
                activeItems.shield.active = true;
                activeItems.shield.timer = Date.now() + ITEM_DURATION;
                player.isShielded = true;
                updateUI();
                checkUpgradeButtonStates();
                messageBox.textContent = `Shield activated for 7 seconds!`;
                messageBox.classList.add('show');
            } else {
                messageBox.textContent = `Not enough gold for Shield! Need ${cost - gold} more.`;
                messageBox.classList.add('show');
            }
        });

        buyBombBtn.addEventListener('click', () => {
            const cost = 700;
            if (gold >= cost) {
                gold -= cost;
                let enemiesDestroyed = 0;
                aliens.forEach(alien => {
                    score += alien.scoreValue;
                    gold += alien.goldValue;
                    coins.push(new Coin(alien.x + alien.width / 2 - 12.5, alien.y + alien.height / 2 - 12.5, alien.goldValue));
                    enemiesDestroyed++;
                });
                bosses.forEach(boss => {
                    score += boss.scoreValue;
                    gold += boss.goldValue;
                    coins.push(new Coin(boss.x + boss.width / 2 - 12.5, boss.y + boss.height / 2 - 12.5, boss.goldValue));
                    enemiesDestroyed++;
                });
                aliens = []; // Clear all aliens
                bosses = []; // Clear all bosses
                updateUI();
                checkUpgradeButtonStates();
                messageBox.textContent = `Bomb deployed! Destroyed ${enemiesDestroyed} enemies!`;
                messageBox.classList.add('show');
            } else {
                messageBox.textContent = `Not enough gold for Bomb! Need ${cost - gold} more.`;
                messageBox.classList.add('show');
            }
        });

        buyHealBtn.addEventListener('click', () => {
            const cost = 200;
            if (gold >= cost) {
                gold -= cost;
                player.heal(50); // Restore 50 health
                updateUI();
                checkUpgradeButtonStates();
                messageBox.textContent = `Repair Kit used! +50 Health!`;
                messageBox.classList.add('show');
            } else {
                messageBox.textContent = `Not enough gold for Repair Kit! Need ${cost - gold} more.`;
                messageBox.classList.add('show');
            }
        });


        // --- Redeem Code ---
        redeemCodeBtn.addEventListener('click', () => {
            const code = redeemCodeInput.value.trim().toUpperCase();
            if (code === "RAAJ") {
                gold += 1000;
                messageBox.textContent = `Code "RAAJ" redeemed! You received 1000 gold!`;
                messageBox.classList.add('show');
                redeemCodeInput.value = '';
            } else if (code === "TONY") {
                gold += 90000;
                messageBox.textContent = `Code "TONY" redeemed! You received 90000 gold! You're rich!`;
                messageBox.classList.add('show');
                redeemCodeInput.value = '';
            } else {
                messageBox.textContent = `Invalid redeem code.`;
                messageBox.classList.add('show');
            }
            updateUI();
            checkUpgradeButtonStates();
        });


        // --- Initial Setup ---
        window.onload = async function() {
            // Preload all images
            try {
                await Promise.all(ALL_IMAGE_URLS.map(url => loadImage(url)));
                console.log("All images loaded.");
            } catch (error) {
                console.error("Error loading images:", error);
                messageBox.textContent = "Error loading game assets. Please refresh.";
                messageBox.classList.add('show');
            } finally {
                // Hide preloader and show game wrapper
                preloader.classList.add('hidden');
                preloader.addEventListener('transitionend', () => {
                    preloader.style.display = 'none';
                });
                initializeGame();
            }
        };
    </script>
</body>
</html>
